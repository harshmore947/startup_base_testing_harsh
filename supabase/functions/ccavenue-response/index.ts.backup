import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';
import { decrypt, parseResponse } from '../_shared/ccavenue-crypto.ts';

serve(async (req) => {
  try {
    console.log('ğŸ“¨ Received CCAvenue callback');
    console.log('ğŸ“ Request method:', req.method);

    // Get and TRIM environment variables
    const WORKING_KEY = Deno.env.get('CCAVENUE_WORKING_KEY')?.trim();
    const FRONTEND_URL = Deno.env.get('FRONTEND_URL')?.trim() || 'http://localhost:5173';

    console.log('ğŸ” WORKING_KEY present:', !!WORKING_KEY);
    console.log('ğŸ” WORKING_KEY length:', WORKING_KEY?.length);
    console.log('ğŸŒ FRONTEND_URL:', FRONTEND_URL);

    if (!WORKING_KEY) {
      console.error('âŒ CCAVENUE_WORKING_KEY not configured');
      return new Response('Configuration error', { status: 500 });
    }

    // Validate working key length
    if (WORKING_KEY.length !== 32) {
      console.error(`âŒ WORKING_KEY invalid length: ${WORKING_KEY.length} (expected 32)`);
      return new Response('Configuration error - invalid key length', { status: 500 });
    }

    // Parse the request (CCAvenue sends POST with form data)
    const formData = await req.formData();
    const encResp = formData.get('encResp') as string;

    console.log('ğŸ“¦ encResp received:', !!encResp);
    console.log('ğŸ“¦ encResp length:', encResp?.length);

    if (!encResp) {
      console.error('âŒ No encrypted response from CCAvenue');
      return Response.redirect(`${FRONTEND_URL}/payment/failure?error=no_response`, 303);
    }

    // Decrypt the response
    let decryptedResponse: string;
    try {
      console.log('ğŸ”“ Attempting to decrypt CCAvenue response...');
      decryptedResponse = await decrypt(encResp, WORKING_KEY);
      console.log('âœ… Decryption successful, response length:', decryptedResponse.length);
      console.log('ğŸ“„ Decrypted response preview:', decryptedResponse.substring(0, 100) + '...');
    } catch (error) {
      console.error('âŒ Decryption failed:', error);
      return Response.redirect(`${FRONTEND_URL}/payment/failure?error=decryption_failed`, 303);
    }

    // Parse the response into object
    const responseParams = parseResponse(decryptedResponse);
    console.log('ğŸ“‹ CCAvenue Response parsed:', JSON.stringify(responseParams, null, 2));

    // Extract important fields
    const {
      order_id,
      tracking_id,
      bank_ref_no,
      order_status,
      failure_message,
      payment_mode,
      card_name,
      status_code,
      status_message,
      amount,
      merchant_param1: plan_type,
      merchant_param2: user_id,
    } = responseParams;

    console.log('ğŸ” Key fields:', {
      order_id,
      tracking_id,
      order_status,
      amount,
      plan_type,
      user_id: user_id?.substring(0, 8) + '...',
    });

    if (!order_id) {
      console.error('âŒ No order_id in response');
      return Response.redirect(`${FRONTEND_URL}/payment/failure?error=invalid_response`, 303);
    }

    // Create Supabase admin client
    const supabaseAdmin = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    // Get the order from database
    const { data: order, error: orderFetchError } = await supabaseAdmin
      .from('orders')
      .select('*')
      .eq('order_id', order_id)
      .single();

    if (orderFetchError || !order) {
      console.error('âŒ Order not found:', order_id, orderFetchError?.message);
      return Response.redirect(`${FRONTEND_URL}/payment/failure?error=order_not_found`, 303);
    }

    console.log('âœ… Order found in database:', order_id);

    // Determine if payment was successful
    const isSuccess = order_status === 'Success';
    const newStatus = isSuccess ? 'success' : 'failed';

    console.log('ğŸ’³ Payment status:', { order_status, isSuccess, newStatus });

    // Update order in database
    const { error: orderUpdateError } = await supabaseAdmin
      .from('orders')
      .update({
        tracking_id,
        bank_ref_no,
        order_status,
        status: newStatus,
        failure_message: failure_message || null,
        payment_mode,
        card_name,
        status_code,
        status_message,
        actual_amount_paid: amount ? parseFloat(amount) : order.amount,
        completed_at: new Date().toISOString(),
        ccavenue_response: responseParams,
      })
      .eq('order_id', order_id);

    if (orderUpdateError) {
      console.error('âŒ Failed to update order:', orderUpdateError);
    } else {
      console.log('âœ… Order updated in database');
    }

    // If payment successful, update user subscription or create research report
    if (isSuccess) {
      console.log('ğŸ‰ Payment successful! Processing order...');

      const subscriptionEndDate = new Date();

      // For premium_annual, add 1 year to subscription
      if (order.plan_type === 'premium_annual') {
        subscriptionEndDate.setFullYear(subscriptionEndDate.getFullYear() + 1);

        const { error: userUpdateError } = await supabaseAdmin
          .from('users')
          .update({
            subscription_status: 'premium',
            subscription_plan: 'premium_annual',
            subscription_end_date: subscriptionEndDate.toISOString(),
          })
          .eq('id', order.user_id);

        if (userUpdateError) {
          console.error('âŒ Failed to update user subscription:', userUpdateError);
        } else {
          console.log('âœ… User subscription updated successfully for:', order.user_id);
        }
      }

      // For research_single, create user_report from pending request
      if (order.plan_type === 'research_single') {
        console.log('ğŸ“ Creating research report for order:', order_id);

        // Fetch pending research request
        const { data: pendingRequest, error: fetchError } = await supabaseAdmin
          .from('pending_research_requests')
          .select('*')
          .eq('order_id', order_id)
          .single();

        if (fetchError || !pendingRequest) {
          console.error('âŒ Failed to fetch pending research request:', fetchError);
          // Continue anyway - redirect to success but log error
        } else {
          console.log('âœ… Found pending research request:', pendingRequest.id);

          // Create user_report
          const { error: reportError } = await supabaseAdmin
            .from('user_reports')
            .insert({
              user_id: order.user_id,
              idea_title: pendingRequest.idea_title,
              idea_description: pendingRequest.idea_description,
              status: 'pending', // Research is pending completion by admin
              order_id: order_id,
              payment_status: 'paid',
            });

          if (reportError) {
            console.error('âŒ Failed to create user report:', reportError);
          } else {
            console.log('âœ… User report created successfully');

            // Delete pending research request (cleanup)
            const { error: deleteError } = await supabaseAdmin
              .from('pending_research_requests')
              .delete()
              .eq('id', pendingRequest.id);

            if (deleteError) {
              console.error('âš ï¸ Failed to delete pending request (non-critical):', deleteError);
            } else {
              console.log('âœ… Pending research request cleaned up');
            }
          }
        }
      }

      // Redirect to success page with order details
      const successUrl = `${FRONTEND_URL}/payment/success?order_id=${order_id}&tracking_id=${tracking_id}&plan_type=${order.plan_type}`;
      console.log('ğŸ”€ Redirecting to success:', successUrl);
      return Response.redirect(successUrl, 303);
    } else {
      // Payment failed - redirect to failure page
      const failureUrl = `${FRONTEND_URL}/payment/failure?order_id=${order_id}&reason=${encodeURIComponent(failure_message || 'Payment failed')}&plan_type=${order.plan_type}`;
      console.log('ğŸ”€ Redirecting to failure:', failureUrl);
      return Response.redirect(failureUrl, 303);
    }

  } catch (error) {
    console.error('âŒ Error in ccavenue-response:', error);
    const FRONTEND_URL = Deno.env.get('FRONTEND_URL')?.trim() || 'http://localhost:5173';
    return Response.redirect(`${FRONTEND_URL}/payment/failure?error=server_error`, 303);
  }
});
